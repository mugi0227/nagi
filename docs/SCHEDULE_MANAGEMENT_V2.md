# スケジュール管理 V2 設計書

## 概要

プロジェクトのスケジュール管理を**2層構造**で再設計する。
個人のタスク管理とプロジェクト全体の計画管理を両立させる。

## 現状の課題

### ボトムアップ積み上げ型の限界
- 現状: タスク見積もり → 積み上げ → スケジュール算出
- 問題: 個人タスク管理では機能するが、プロジェクト管理では「木を見て森を見ず」になる
- 結果: プロジェクト全体として破綻しないか不安が残る

### 欲しいもの
1. **個人視点**: 「このタスクはいつやればいい？」という安心感
2. **プロジェクト視点**: 全体として破綻しないスケジュール管理
3. **柔軟性**: 依存関係があるタスクをまとめて動かせる

---

## 設計方針: 2層構造のスケジュール管理

### マクロ層（プロジェクト視点）
- **管理単位**: フェーズ + マイルストーン
- **決め方**: トップダウン（PM/チームで決定）
- **特徴**: 期限は固定的、バッファで吸収する前提
- **可視化**: ガントチャートのメイン表示

### ミクロ層（個人視点）
- **管理単位**: タスク
- **決め方**: ボトムアップ（AIが自動計算）
- **特徴**: フェーズ内でいつやるかはAIが最適化
- **可視化**: 日々のタスクリスト、ガントでは折りたたみ表示

```
【マクロ層】PM が管理
プロジェクト
├── フェーズ1（設計）─── マイルストーン: 設計完了 (1/31) ─── バッファ: 8h
├── フェーズ2（実装）─── マイルストーン: 実装完了 (2/28) ─── バッファ: 20h
└── フェーズ3（テスト）─ マイルストーン: リリース (3/15) ─── バッファ: 10h

【ミクロ層】AI が最適化
├── 担当者A: 今日やること → タスクX, タスクY
├── 担当者B: 今日やること → タスクZ
└── 担当者C: 今日やること → タスクW
```

---

## バッファ管理（CCPM）

### バッファの持ち方
- **フェーズ単位**でバッファを保持
- 各フェーズの見積もり合計に対してバッファ率（デフォルト50%）を適用
- 遅延発生時はバッファを消費

### バッファ計算
```
フェーズバッファ = Σ(タスク見積もり) × バッファ率

例: フェーズ1
- タスク見積もり合計: 40h
- バッファ率: 50%
- バッファ: 20h
- フェーズ期間: 40h + 20h = 60h
```

### バッファ消費の追跡
```
消費率 = 消費済みバッファ / 総バッファ × 100%

ステータス:
- healthy (緑): 消費率 < 33%
- warning (黄): 消費率 33% - 67%
- critical (赤): 消費率 >= 67%
```

### バッファ消費の計算方法
```
消費済みバッファ = max(0, 現在の進捗遅延)

進捗遅延 = 予定完了タスク工数 - 実際完了タスク工数
         = (経過日数 / フェーズ日数) × タスク総工数 - 完了タスク工数
```

---

## 責務分担

| 層 | 管理対象 | 決め方 | 誰が気にする | 変更頻度 |
|---|---|---|---|---|
| プロジェクト | フェーズ構成 | PM/チームで決定 | PM | 稀 |
| フェーズ | マイルストーン期限 + バッファ | 逆算で設定 | PM | 月1程度 |
| タスク | 何をやるか、誰がやるか | フェーズに紐づけ | PM/担当者 | 週1程度 |
| 日々のスケジュール | いつやるか | **AIが自動計算** | 担当者 | 毎日 |

---

## データモデル変更

### 既存モデルの活用（変更なし）
- `Phase`: start_date, end_date はそのまま活用
- `Milestone`: due_date はそのまま活用
- `Task`: due_date, dependency_ids, estimated_minutes はそのまま活用
- `ScheduleSnapshot`: フェーズ単位のバッファ情報を保持（既存）

### タスクの日程管理方針（重要）
**タスクの `planned_start/planned_end` は「参考情報」として扱う**

```
現状: タスクに planned_start/planned_end を厳密に持たせている
変更: これらは「AIが計算した推奨日程」として扱い、強制しない

理由:
- フェーズ期限さえ守れば、細かい日程は柔軟に変更可能
- 担当者のキャパシティ変動に対応しやすい
- AIが毎日最適化するので、固定する必要がない
```

### 新規追加: なし
既存モデルで十分対応可能。ロジック変更のみ。

---

## AIタスク提案ロジック（強化）

### 現状のロジック
```
優先度スコア = f(due_date, dependency, estimated_minutes, ...)
→ スコア順に今日のキャパシティまで割り当て
```

### 強化版ロジック
```
1. フェーズ余裕度の計算
   フェーズ余裕度 = (フェーズ残日数 × 日キャパ - 残タスク工数) / フェーズバッファ

2. 優先度スコアの調整
   調整後スコア = 基本スコア × (1 + max(0, 1 - フェーズ余裕度))

   → フェーズ余裕度が低い（バッファ食い込み）タスクの優先度が上がる

3. 「今日やること」の決定
   - 調整後スコア順にソート
   - 日キャパシティまで割り当て
   - 「これをやれば大丈夫」という安心感を提供
```

### 余裕度による表示
```
余裕度 > 1.0: 余裕あり（緑）「予定通り進めてOK」
余裕度 0.5-1.0: 注意（黄）「バッファ消費中」
余裕度 < 0.5: 危険（赤）「このタスクを優先して」
```

---

## ガントチャート表示

### 表示階層
```
プロジェクト名
├── [フェーズ1] ████████████████░░░░ (バッファ表示)
│   ├── マイルストーン: 設計完了 ◆ 1/31
│   └── [折りたたみ] タスク一覧 (12件)
│       ├── タスクA ████
│       ├── タスクB ██████
│       └── ...
├── [フェーズ2] ░░░░░░████████████████████░░░░
│   └── ...
```

### 表示モード
1. **フェーズビュー（デフォルト）**: フェーズ + マイルストーンのみ
2. **詳細ビュー**: フェーズを展開してタスクも表示

### バッファの可視化
- フェーズバーの末尾にバッファ領域を表示（薄い色）
- 消費済みバッファは色を変えて表示
- バッファステータス（healthy/warning/critical）をアイコンで表示

### 依存関係の表示
- フェーズ間の依存関係を矢印で表示
- タスク展開時はタスク間の依存も表示
- クリティカルパスをハイライト（オプション）

---

## 操作フロー

### PM の操作
```
1. フェーズを作成、マイルストーン期限を設定
2. タスクをフェーズに割り当て、担当者を設定
3. ベースラインを作成（バッファ自動計算）
4. 定期的にバッファ消費率を確認
5. 危険な場合はスコープ調整 or リソース追加
```

### 担当者の操作
```
1. 「今日のタスク」を確認（AIが最適化済み）
2. タスクを実行、完了したらステータス変更
3. 必要に応じて見積もり時間を更新
4. フェーズ期限だけ意識すればOK
```

### システムの動作
```
毎日:
1. 各担当者のキャパシティを確認
2. フェーズ余裕度を計算
3. 優先度スコアを調整
4. 「今日のタスク」を生成
5. バッファ消費率を更新
6. 危険なフェーズがあればアラート
```

---

## 実装計画

### Phase 1: ガントチャートUI改修
- [ ] フェーズ/マイルストーン中心の表示に変更
- [ ] タスクを折りたたみ表示に
- [ ] バッファ領域の可視化
- [ ] バッファステータスアイコン

### Phase 2: AIタスク提案ロジック強化
- [ ] フェーズ余裕度計算の実装
- [ ] 優先度スコア調整ロジック
- [ ] 「今日のタスク」表示の改善
- [ ] 余裕度インジケーター追加

### Phase 3: バッファ消費追跡
- [ ] バッファ消費率の自動計算
- [ ] 危険フェーズのアラート
- [ ] ダッシュボードでのバッファ状況表示

### Phase 4: 依存関係の一括操作
- [ ] フェーズ移動時の関連タスク一括移動
- [ ] 依存関係のあるタスクの一括日程調整

---

## 既存実装との差分

### 変更が必要な箇所
1. **フロントエンド**
   - `ProjectGanttContent.tsx`: フェーズ中心表示、タスク折りたたみ
   - `GanttChartView.tsx`: 同上（使用箇所に応じて）
   - タスク提案UI: 余裕度インジケーター追加

2. **バックエンド**
   - `planner_service.py`: 優先度スコア調整ロジック追加
   - `schedule_snapshot_service.py`: バッファ消費率の自動計算強化

### 変更不要な箇所（既存活用）
- `ScheduleSnapshot` モデル: フェーズバッファ情報は既に保持
- `PhaseBufferInfo`: バッファステータス判定ロジックは既存
- フェーズ/マイルストーン API: そのまま利用
- タスク依存関係: そのまま利用

---

## 成功指標

1. **PM 視点**
   - バッファ消費率を見るだけでプロジェクト健全性がわかる
   - フェーズ期限の遅延リスクを早期に検知できる

2. **担当者視点**
   - 「今日やること」を見るだけで安心して作業できる
   - フェーズ期限を意識するだけで細かい日程管理が不要

3. **システム視点**
   - 毎日の最適化で常に最新の推奨タスクを提示
   - バッファ消費に応じた優先度自動調整
